<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AiChat API 完整测试</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // 模拟 AiChat 类的完整实现
        class AiChat {
            constructor(userId, projectId, baseUrl = 'http://localhost:3001/api', className = '') {
                this.userId = userId;
                this.projectId = projectId;
                this.baseUrl = baseUrl;
                this.className = className;
                
                console.log('🎯 AiChat 实例创建:', {
                    userId: this.userId,
                    projectId: this.projectId,
                    baseUrl: this.baseUrl,
                    className: this.className
                });
            }
            
            render() {
                console.log('🎨 渲染 AiChat 组件...');
                
                // 返回一个功能完整的聊天界面组件
                return React.createElement(ChatInterface, {
                    userId: this.userId,
                    projectId: this.projectId,
                    baseUrl: this.baseUrl,
                    className: this.className
                });
            }
            
            getStore() {
                return {
                    userId: this.userId,
                    projectId: this.projectId,
                    baseUrl: this.baseUrl
                };
            }
            
            getApiClient() {
                return {
                    baseUrl: this.baseUrl,
                    get: (url) => console.log(`GET ${this.baseUrl}${url}`),
                    post: (url, data) => console.log(`POST ${this.baseUrl}${url}`, data)
                };
            }
        }
        
        // 聊天界面组件
        function ChatInterface({ userId, projectId, baseUrl, className }) {
            const [messages, setMessages] = useState([
                {
                    id: '1',
                    role: 'assistant',
                    content: `👋 你好！我是 AiChat 助手。\n\n当前配置:\n- 用户ID: ${userId}\n- 项目ID: ${projectId}\n- API地址: ${baseUrl}`,
                    timestamp: new Date()
                }
            ]);
            const [inputValue, setInputValue] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const messagesEndRef = useRef(null);
            
            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };
            
            useEffect(() => {
                scrollToBottom();
            }, [messages]);
            
            const handleSendMessage = async () => {
                if (!inputValue.trim()) return;
                
                const userMessage = {
                    id: Date.now().toString(),
                    role: 'user',
                    content: inputValue,
                    timestamp: new Date()
                };
                
                setMessages(prev => [...prev, userMessage]);
                setInputValue('');
                setIsLoading(true);
                
                // 模拟 API 调用
                setTimeout(() => {
                    const assistantMessage = {
                        id: (Date.now() + 1).toString(),
                        role: 'assistant',
                        content: `收到你的消息: "${inputValue}"\n\n这是一个模拟回复。在真实环境中，这里会调用 ${baseUrl} 的 API 来获取 AI 回复。`,
                        timestamp: new Date()
                    };
                    
                    setMessages(prev => [...prev, assistantMessage]);
                    setIsLoading(false);
                }, 1000);
            };
            
            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            };
            
            return (
                <div className={`flex flex-col h-full bg-white ${className}`}>
                    {/* 头部 */}
                    <div className="bg-blue-600 text-white p-4">
                        <h2 className="text-lg font-semibold">🤖 AiChat 界面</h2>
                        <p className="text-sm opacity-90">用户: {userId} | 项目: {projectId}</p>
                    </div>
                    
                    {/* 消息列表 */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        {messages.map((message) => (
                            <div
                                key={message.id}
                                className={`flex ${message.role === 'user' ? 'justify-end' : 'justify-start'}`}
                            >
                                <div
                                    className={`max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
                                        message.role === 'user'
                                            ? 'bg-blue-600 text-white'
                                            : 'bg-gray-200 text-gray-800'
                                    }`}
                                >
                                    <div className="whitespace-pre-wrap">{message.content}</div>
                                    <div className={`text-xs mt-1 ${
                                        message.role === 'user' ? 'text-blue-100' : 'text-gray-500'
                                    }`}>
                                        {message.timestamp.toLocaleTimeString()}
                                    </div>
                                </div>
                            </div>
                        ))}
                        
                        {isLoading && (
                            <div className="flex justify-start">
                                <div className="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg">
                                    <div className="flex items-center space-x-2">
                                        <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-gray-600"></div>
                                        <span>正在思考...</span>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        <div ref={messagesEndRef} />
                    </div>
                    
                    {/* 输入区域 */}
                    <div className="border-t p-4">
                        <div className="flex space-x-2">
                            <textarea
                                value={inputValue}
                                onChange={(e) => setInputValue(e.target.value)}
                                onKeyPress={handleKeyPress}
                                placeholder="输入消息..."
                                className="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                                rows="1"
                                disabled={isLoading}
                            />
                            <button
                                onClick={handleSendMessage}
                                disabled={isLoading || !inputValue.trim()}
                                className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                发送
                            </button>
                        </div>
                    </div>
                </div>
            );
        }
        
        // 主测试应用
        function TestApp() {
            const [aiChatInstances, setAiChatInstances] = useState([]);
            const [selectedInstance, setSelectedInstance] = useState(null);
            
            useEffect(() => {
                // 创建多个 AiChat 实例进行测试
                const instances = [
                    {
                        id: 'instance1',
                        name: '测试实例 1',
                        aiChat: new AiChat('user_001', 'project_alpha', 'http://localhost:3001/api', 'border-2 border-blue-500')
                    },
                    {
                        id: 'instance2', 
                        name: '测试实例 2',
                        aiChat: new AiChat('user_002', 'project_beta', 'http://localhost:3002/api', 'border-2 border-green-500')
                    },
                    {
                        id: 'instance3',
                        name: '测试实例 3', 
                        aiChat: new AiChat('user_003', 'project_gamma', 'http://localhost:3003/api', 'border-2 border-purple-500')
                    }
                ];
                
                setAiChatInstances(instances);
                setSelectedInstance(instances[0]);
            }, []);
            
            return (
                <div className="min-h-screen bg-gray-100">
                    <div className="container mx-auto p-4">
                        {/* 头部 */}
                        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                            <h1 className="text-2xl font-bold text-gray-800 mb-2">
                                🧪 AiChat API 完整测试
                            </h1>
                            <p className="text-gray-600">
                                测试通过 <code className="bg-gray-100 px-2 py-1 rounded">new AiChat(user_id, project_id, base_url)</code> 创建和使用聊天组件
                            </p>
                        </div>
                        
                        {/* 实例选择器 */}
                        <div className="bg-white rounded-lg shadow-md p-4 mb-6">
                            <h3 className="text-lg font-semibold mb-3">选择测试实例:</h3>
                            <div className="flex space-x-2">
                                {aiChatInstances.map((instance) => (
                                    <button
                                        key={instance.id}
                                        onClick={() => setSelectedInstance(instance)}
                                        className={`px-4 py-2 rounded-lg border ${
                                            selectedInstance?.id === instance.id
                                                ? 'bg-blue-600 text-white border-blue-600'
                                                : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'
                                        }`}
                                    >
                                        {instance.name}
                                    </button>
                                ))}
                            </div>
                        </div>
                        
                        {/* 实例信息 */}
                        {selectedInstance && (
                            <div className="bg-white rounded-lg shadow-md p-4 mb-6">
                                <h3 className="text-lg font-semibold mb-3">当前实例信息:</h3>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">用户ID</label>
                                        <div className="mt-1 text-sm text-gray-900">{selectedInstance.aiChat.userId}</div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">项目ID</label>
                                        <div className="mt-1 text-sm text-gray-900">{selectedInstance.aiChat.projectId}</div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">API地址</label>
                                        <div className="mt-1 text-sm text-gray-900">{selectedInstance.aiChat.baseUrl}</div>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {/* 聊天界面 */}
                        {selectedInstance && (
                            <div className="bg-white rounded-lg shadow-md overflow-hidden" style={{ height: '600px' }}>
                                {selectedInstance.aiChat.render()}
                            </div>
                        )}
                        
                        {/* API 使用说明 */}
                        <div className="bg-white rounded-lg shadow-md p-6 mt-6">
                            <h3 className="text-lg font-semibold mb-3">📚 API 使用说明</h3>
                            <div className="bg-gray-50 rounded-lg p-4">
                                <pre className="text-sm text-gray-800 overflow-x-auto">
{`// 1. 导入 AiChat 类
import { AiChat } from '@your-package/ai-chat';

// 2. 创建实例
const aiChat = new AiChat(
    'user_123',                    // 用户ID
    'project_456',                 // 项目ID  
    'http://localhost:3001/api',   // API基础URL (可选)
    'custom-class-name'            // CSS类名 (可选)
);

// 3. 渲染组件
const chatElement = aiChat.render();

// 4. 挂载到 React 应用
function App() {
    return (
        <div>
            {chatElement}
        </div>
    );
}

// 5. 获取实例信息 (高级用法)
const store = aiChat.getStore();
const apiClient = aiChat.getApiClient();`}
                                </pre>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }
        
        // 渲染应用
        ReactDOM.render(<TestApp />, document.getElementById('root'));
    </script>
</body>
</html>