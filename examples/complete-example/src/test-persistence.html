<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wa-sqlite + OPFS æŒä¹…åŒ–æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .info {
            color: #17a2b8;
        }
        #results {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—„ï¸ wa-sqlite + OPFS æŒä¹…åŒ–æµ‹è¯•</h1>
        
        <div class="test-section">
            <h3>ğŸ“ æµ‹è¯•è¯´æ˜</h3>
            <p>è¿™ä¸ªæµ‹è¯•é¡µé¢éªŒè¯ wa-sqlite + OPFS çš„æ•°æ®æŒä¹…åŒ–åŠŸèƒ½ï¼š</p>
            <ul>
                <li>âœ… åˆ›å»ºæ•°æ®åº“å¹¶æ’å…¥æµ‹è¯•æ•°æ®</li>
                <li>âœ… éªŒè¯æ•°æ®å¯ä»¥æ­£å¸¸è¯»å–</li>
                <li>ğŸ”„ <strong>å…³é—­æµè§ˆå™¨æ ‡ç­¾é¡µï¼Œé‡æ–°æ‰“å¼€æ­¤é¡µé¢</strong></li>
                <li>âœ… éªŒè¯æ•°æ®æ˜¯å¦ä»ç„¶å­˜åœ¨ï¼ˆæŒä¹…åŒ–æµ‹è¯•ï¼‰</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>ğŸš€ æ“ä½œæŒ‰é’®</h3>
            <button onclick="initDatabase()">åˆå§‹åŒ–æ•°æ®åº“</button>
            <button onclick="insertTestData()">æ’å…¥æµ‹è¯•æ•°æ®</button>
            <button onclick="queryData()">æŸ¥è¯¢æ‰€æœ‰æ•°æ®</button>
            <button onclick="clearData()">æ¸…ç©ºæ•°æ®</button>
            <button onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š æµ‹è¯•ç»“æœ</h3>
            <div id="results">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
        </div>

        <div class="test-section">
            <h3>ğŸ’¡ æŒä¹…åŒ–éªŒè¯æ­¥éª¤</h3>
            <ol>
                <li>ç‚¹å‡» "åˆå§‹åŒ–æ•°æ®åº“" æŒ‰é’®</li>
                <li>ç‚¹å‡» "æ’å…¥æµ‹è¯•æ•°æ®" æŒ‰é’®</li>
                <li>ç‚¹å‡» "æŸ¥è¯¢æ‰€æœ‰æ•°æ®" éªŒè¯æ•°æ®å·²æ’å…¥</li>
                <li><strong>å…³é—­æ­¤æµè§ˆå™¨æ ‡ç­¾é¡µ</strong></li>
                <li><strong>é‡æ–°æ‰“å¼€æ­¤é¡µé¢</strong></li>
                <li>ç‚¹å‡» "åˆå§‹åŒ–æ•°æ®åº“" æŒ‰é’®</li>
                <li>ç‚¹å‡» "æŸ¥è¯¢æ‰€æœ‰æ•°æ®" æŒ‰é’®</li>
                <li>å¦‚æœèƒ½çœ‹åˆ°ä¹‹å‰æ’å…¥çš„æ•°æ®ï¼Œè¯´æ˜æŒä¹…åŒ–æˆåŠŸï¼</li>
            </ol>
        </div>
    </div>

    <script type="module">
        // å¯¼å…¥ wa-sqlite
        import SQLiteESMFactory from '/node_modules/wa-sqlite/dist/wa-sqlite.mjs';
        import * as SQLiteAPI from '/node_modules/wa-sqlite/src/sqlite-api.js';

        let sqlite3 = null;
        let db = null;
        const dbName = 'test-persistence.db';

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            results.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            results.scrollTop = results.scrollHeight;
        }

        // OPFS VFS ç®€åŒ–å®ç°
        class SimpleOPFSVfs {
            constructor() {
                this.opfsRoot = null;
                this.fileHandle = null;
                this.accessHandle = null;
            }

            async init() {
                try {
                    if ('storage' in navigator && 'getDirectory' in navigator.storage) {
                        this.opfsRoot = await navigator.storage.getDirectory();
                        log('OPFS åˆå§‹åŒ–æˆåŠŸ', 'success');
                        return true;
                    } else {
                        log('æ­¤æµè§ˆå™¨ä¸æ”¯æŒ OPFS', 'error');
                        return false;
                    }
                } catch (error) {
                    log(`OPFS åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                    return false;
                }
            }

            async openFile(filename) {
                try {
                    this.fileHandle = await this.opfsRoot.getFileHandle(filename, { create: true });
                    this.accessHandle = await this.fileHandle.createSyncAccessHandle();
                    log(`æ–‡ä»¶ ${filename} æ‰“å¼€æˆåŠŸ`, 'success');
                    return true;
                } catch (error) {
                    log(`æ–‡ä»¶æ‰“å¼€å¤±è´¥: ${error.message}`, 'error');
                    return false;
                }
            }

            async closeFile() {
                if (this.accessHandle) {
                    await this.accessHandle.close();
                    this.accessHandle = null;
                    this.fileHandle = null;
                }
            }
        }

        const vfs = new SimpleOPFSVfs();

        window.initDatabase = async function() {
            try {
                log('å¼€å§‹åˆå§‹åŒ–æ•°æ®åº“...');
                
                // åˆå§‹åŒ– OPFS
                const opfsSupported = await vfs.init();
                if (!opfsSupported) {
                    log('é™çº§åˆ°å†…å­˜æ•°æ®åº“æ¨¡å¼', 'info');
                }

                // åˆå§‹åŒ– wa-sqlite
                const module = await SQLiteESMFactory();
                sqlite3 = SQLiteAPI.Factory(module);
                log('wa-sqlite æ¨¡å—åŠ è½½æˆåŠŸ', 'success');

                // æ‰“å¼€æ•°æ®åº“ï¼ˆå…ˆä½¿ç”¨å†…å­˜æ¨¡å¼ï¼‰
                db = await sqlite3.open_v2(':memory:', SQLiteAPI.SQLITE_OPEN_CREATE | SQLiteAPI.SQLITE_OPEN_READWRITE);
                log('æ•°æ®åº“è¿æ¥æˆåŠŸ', 'success');

                // åˆ›å»ºæµ‹è¯•è¡¨
                await sqlite3.exec(db, `
                    CREATE TABLE IF NOT EXISTS test_data (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        name TEXT NOT NULL,
                        value TEXT NOT NULL,
                        created_at DATETIME DEFAULT CURRENT_TIMESTAMP
                    );
                `);
                log('æµ‹è¯•è¡¨åˆ›å»ºæˆåŠŸ', 'success');
                
            } catch (error) {
                log(`æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
            }
        };

        window.insertTestData = async function() {
            if (!sqlite3 || !db) {
                log('è¯·å…ˆåˆå§‹åŒ–æ•°æ®åº“', 'error');
                return;
            }

            try {
                const timestamp = new Date().toISOString();
                const testData = [
                    ['ç”¨æˆ·1', `æµ‹è¯•æ•°æ® - ${timestamp}`],
                    ['ç”¨æˆ·2', `å¦ä¸€æ¡æµ‹è¯•æ•°æ® - ${timestamp}`],
                    ['æŒä¹…åŒ–æµ‹è¯•', `è¿™æ¡æ•°æ®ç”¨äºéªŒè¯æŒä¹…åŒ– - ${timestamp}`]
                ];

                for (const [name, value] of testData) {
                    await sqlite3.exec(db, 
                        'INSERT INTO test_data (name, value) VALUES (?, ?)', 
                        [name, value]
                    );
                }
                
                log(`æˆåŠŸæ’å…¥ ${testData.length} æ¡æµ‹è¯•æ•°æ®`, 'success');
            } catch (error) {
                log(`æ’å…¥æ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        };

        window.queryData = async function() {
            if (!sqlite3 || !db) {
                log('è¯·å…ˆåˆå§‹åŒ–æ•°æ®åº“', 'error');
                return;
            }

            try {
                const results = [];
                
                for await (const stmt of sqlite3.statements(db, 'SELECT * FROM test_data ORDER BY id')) {
                    while (await sqlite3.step(stmt) === SQLiteAPI.SQLITE_ROW) {
                        const row = sqlite3.row(stmt);
                        results.push(row);
                    }
                }

                if (results.length === 0) {
                    log('æ•°æ®åº“ä¸­æ²¡æœ‰æ•°æ®', 'info');
                } else {
                    log(`æŸ¥è¯¢åˆ° ${results.length} æ¡æ•°æ®:`, 'success');
                    results.forEach((row, index) => {
                        log(`  ${index + 1}. ID: ${row[0]}, åç§°: ${row[1]}, å€¼: ${row[2]}, æ—¶é—´: ${row[3]}`);
                    });
                }
            } catch (error) {
                log(`æŸ¥è¯¢æ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        };

        window.clearData = async function() {
            if (!sqlite3 || !db) {
                log('è¯·å…ˆåˆå§‹åŒ–æ•°æ®åº“', 'error');
                return;
            }

            try {
                await sqlite3.exec(db, 'DELETE FROM test_data');
                log('æ‰€æœ‰æ•°æ®å·²æ¸…ç©º', 'success');
            } catch (error) {
                log(`æ¸…ç©ºæ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        };

        window.clearResults = function() {
            document.getElementById('results').innerHTML = 'ç»“æœå·²æ¸…ç©º...\n';
        };

        // é¡µé¢åŠ è½½æ—¶çš„æç¤º
        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œè¯·ç‚¹å‡» "åˆå§‹åŒ–æ•°æ®åº“" å¼€å§‹æµ‹è¯•');
            log('æ³¨æ„ï¼šå½“å‰å®ç°ä½¿ç”¨å†…å­˜æ•°æ®åº“ï¼ŒçœŸæ­£çš„ OPFS æŒä¹…åŒ–éœ€è¦æ›´å¤æ‚çš„ VFS å®ç°');
        });
    </script>
</body>
</html>