我来帮你完善这个React AI聊天组件的完整需求规范：

## 📋 完整需求规范文档

### 🎯 项目概述

**项目名称**: `@ai-chat/react-component`
**项目类型**: React组件库 (NPM包)
**目标**: 提供一个开箱即用的AI聊天组件，支持完整的对话管理和扩展功能

### 🏗 技术架构需求

#### 核心技术栈
```json
{
  "framework": {
    "react": "^18.2.0",
    "typescript": "^5.0.0"
  },
  "build": {
    "vite": "^5.0.0",
    "rollup": "^4.0.0"
  },
  "ui": {
    "tailwindcss": "^3.4.0",
    "@radix-ui/react-dialog": "^1.0.5",
    "@radix-ui/react-dropdown-menu": "^2.0.6",
    "@radix-ui/react-tooltip": "^1.0.7",
    "lucide-react": "^0.400.0",
    "framer-motion": "^11.0.0"
  },
  "state": {
    "zustand": "^4.5.0",
    "immer": "^10.0.0"
  },
  "ai": {
    "openai": "^4.20.0",
    "@modelcontextprotocol/sdk": "^0.5.0"
  },
  "database": {
    "better-sqlite3": "^9.0.0",
    "drizzle-orm": "^0.29.0"
  },
  "markdown": {
    "react-markdown": "^9.0.0",
    "remark-gfm": "^4.0.0",
    "rehype-highlight": "^7.0.0",
    "rehype-katex": "^7.0.0"
  }
}
```

### 🎨 UI/UX 需求

#### 界面布局
- **主容器**: 可配置宽高的聊天容器
- **消息布局**: 左对齐，用户消息蓝色背景，AI消息无背景
- **会话管理**: 顶部弹出式会话列表
- **输入区域**: 底部固定输入框，支持多行和快捷键
- **状态指示**: 连接状态、输入状态、错误提示

#### 主题系统
```typescript
interface ThemeConfig {
  mode: 'light' | 'dark' | 'auto';
  colors: {
    primary: string;
    secondary: string;
    background: string;
    surface: string;
    text: string;
    userMessage: string;
    assistantMessage: string;
    border: string;
    error: string;
    success: string;
  };
  typography: {
    fontFamily: string;
    fontSize: {
      sm: string;
      base: string;
      lg: string;
    };
  };
  spacing: {
    xs: string;
    sm: string;
    md: string;
    lg: string;
    xl: string;
  };
}
```

### 💬 聊天功能需求

#### 消息处理
- **消息类型**: 文本、图片、文件、代码块
- **流式渲染**: 实时显示AI回复过程
- **Markdown支持**: 完整的Markdown语法渲染
- **代码高亮**: 支持多种编程语言
- **数学公式**: LaTeX/KaTeX数学公式渲染
- **消息状态**: 发送中、已发送、失败、重试

#### 交互功能
- **消息操作**: 复制、编辑、删除、重新发送
- **快捷键**: Enter发送、Shift+Enter换行、Ctrl+K清空
- **文件上传**: 拖拽上传、粘贴图片
- **消息搜索**: 全文搜索历史消息
- **导出功能**: 导出对话为Markdown/PDF

### 📊 会话管理需求

#### 会话功能
```typescript
interface Session {
  id: string;
  title: string;
  createdAt: Date;
  updatedAt: Date;
  messageCount: number;
  tokenUsage: number;
  tags: string[];
  pinned: boolean;
  archived: boolean;
  metadata: {
    model: string;
    systemPrompt?: string;
    temperature: number;
    maxTokens: number;
  };
}

interface SessionOperations {
  create: (title?: string) => Promise<Session>;
  update: (id: string, updates: Partial<Session>) => Promise<void>;
  delete: (id: string) => Promise<void>;
  archive: (id: string) => Promise<void>;
  pin: (id: string) => Promise<void>;
  search: (query: string) => Promise<Session[]>;
  export: (id: string, format: 'json' | 'markdown') => Promise<string>;
  import: (data: string, format: 'json' | 'markdown') => Promise<Session>;
}
```

#### 会话列表UI
- **搜索过滤**: 按标题、标签、时间搜索
- **排序选项**: 时间、消息数量、使用频率
- **批量操作**: 批量删除、归档、导出
- **分页加载**: 虚拟滚动处理大量会话

### 🔧 MCP配置需求

#### MCP集成
```typescript
interface MCPServer {
  id: string;
  name: string;
  description: string;
  serverUrl: string;
  enabled: boolean;
  version: string;
  capabilities: string[];
  tools: MCPTool[];
  status: 'connected' | 'disconnected' | 'error';
  lastConnected?: Date;
  config: Record<string, any>;
}

interface MCPTool {
  name: string;
  description: string;
  parameters: Record<string, any>;
  enabled: boolean;
}

interface MCPManager {
  servers: MCPServer[];
  addServer: (config: Omit<MCPServer, 'id' | 'status'>) => Promise<void>;
  removeServer: (id: string) => Promise<void>;
  testConnection: (id: string) => Promise<boolean>;
  executeTool: (serverId: string, toolName: string, params: any) => Promise<any>;
  getAvailableTools: () => MCPTool[];
}
```

#### MCP配置界面
- **服务器管理**: 添加、编辑、删除MCP服务器
- **工具配置**: 启用/禁用特定工具
- **连接测试**: 测试MCP服务器连接状态
- **日志监控**: MCP调用日志和错误追踪

### 💾 数据持久化需求

#### 数据库Schema
```sql
-- 会话表
CREATE TABLE sessions (
  id TEXT PRIMARY KEY,
  title TEXT NOT NULL,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL,
  message_count INTEGER DEFAULT 0,
  token_usage INTEGER DEFAULT 0,
  tags TEXT, -- JSON array
  pinned BOOLEAN DEFAULT FALSE,
  archived BOOLEAN DEFAULT FALSE,
  metadata TEXT -- JSON object
);

-- 消息表
CREATE TABLE messages (
  id TEXT PRIMARY KEY,
  session_id TEXT NOT NULL,
  role TEXT NOT NULL CHECK (role IN ('user', 'assistant', 'system')),
  content TEXT NOT NULL,
  raw_content TEXT, -- 原始内容（用于编辑）
  tokens_used INTEGER,
  created_at INTEGER NOT NULL,
  updated_at INTEGER,
  metadata TEXT, -- JSON object (attachments, etc.)
  FOREIGN KEY (session_id) REFERENCES sessions (id) ON DELETE CASCADE
);

-- MCP配置表
CREATE TABLE mcp_configs (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  server_url TEXT NOT NULL,
  enabled BOOLEAN DEFAULT TRUE,
  config TEXT, -- JSON configuration
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL
);

-- 用户配置表
CREATE TABLE user_configs (
  key TEXT PRIMARY KEY,
  value TEXT NOT NULL,
  updated_at INTEGER NOT NULL
);
```

#### 数据库操作
```typescript
interface DatabaseOperations {
  // 会话操作
  sessions: {
    create: (session: Omit<Session, 'id'>) => Promise<Session>;
    findById: (id: string) => Promise<Session | null>;
    findAll: (options?: QueryOptions) => Promise<Session[]>;
    update: (id: string, updates: Partial<Session>) => Promise<void>;
    delete: (id: string) => Promise<void>;
    search: (query: string) => Promise<Session[]>;
  };
  
  // 消息操作
  messages: {
    create: (message: Omit<Message, 'id'>) => Promise<Message>;
    findBySessionId: (sessionId: string) => Promise<Message[]>;
    update: (id: string, updates: Partial<Message>) => Promise<void>;
    delete: (id: string) => Promise<void>;
  };
  
  // 配置操作
  configs: {
    get: (key: string) => Promise<any>;
    set: (key: string, value: any) => Promise<void>;
    delete: (key: string) => Promise<void>;
  };
  
  // 数据库维护
  maintenance: {
    backup: () => Promise<string>;
    restore: (backup: string) => Promise<void>;
    vacuum: () => Promise<void>;
    migrate: (version: number) => Promise<void>;
  };
}
```

### 🤖 AI集成需求

#### OpenAI配置
```typescript
interface OpenAIConfig {
  apiKey: string;
  baseURL?: string;
  organization?: string;
  project?: string;
  model: string;
  maxTokens: number;
  temperature: number;
  topP?: number;
  frequencyPenalty?: number;
  presencePenalty?: number;
  stop?: string[];
  systemPrompt?: string;
}

interface StreamingOptions {
  onStart?: () => void;
  onToken?: (token: string) => void;
  onComplete?: (fullResponse: string) => void;
  onError?: (error: Error) => void;
}
```

#### AI功能特性
- **多模型支持**: GPT-3.5, GPT-4, GPT-4 Turbo, GPT-4V
- **流式响应**: 实时显示生成过程
- **上下文管理**: 智能上下文窗口管理
- **函数调用**: 支持OpenAI Functions
- **图像理解**: GPT-4V图像分析
- **错误处理**: 网络错误、API限制处理

### 📦 组件API设计

#### 主组件接口
```typescript
interface AIChatProps {
  // 必需配置
  apiKey: string;
  
  // OpenAI配置
  model?: string;
  baseURL?: string;
  systemPrompt?: string;
  maxTokens?: number;
  temperature?: number;
  
  // 组件配置
  width?: string | number;
  height?: string | number;
  className?: string;
  theme?: ThemeConfig | 'light' | 'dark' | 'auto';
  
  // 数据库配置
  databasePath?: string;
  enablePersistence?: boolean;
  
  // MCP配置
  mcpServers?: MCPServer[];
  enableMCP?: boolean;
  
  // 功能开关
  enableMarkdown?: boolean;
  enableCodeHighlight?: boolean;
  enableMath?: boolean;
  enableFileUpload?: boolean;
  enableSearch?: boolean;
  enableExport?: boolean;
  
  // 自定义配置
  placeholder?: string;
  maxMessageLength?: number;
  showTokenCount?: boolean;
  showTimestamp?: boolean;
  
  // 事件回调
  onMessageSent?: (message: Message) => void;
  onMessageReceived?: (message: Message) => void;
  onSessionChange?: (session: Session) => void;
  onError?: (error: Error) => void;
  onTokenUsage?: (usage: TokenUsage) => void;
  
  // 自定义渲染
  renderMessage?: (message: Message) => React.ReactNode;
  renderInput?: (props: InputProps) => React.ReactNode;
  renderHeader?: (props: HeaderProps) => React.ReactNode;
}
```

#### Hook接口
```typescript
// 聊天状态管理
export function useChatStore(): {
  sessions: Session[];
  currentSession: Session | null;
  messages: Message[];
  isLoading: boolean;
  error: string | null;
  
  // 会话操作
  createSession: (title?: string) => Promise<void>;
  switchSession: (sessionId: string) => Promise<void>;
  deleteSession: (sessionId: string) => Promise<void>;
  
  // 消息操作
  sendMessage: (content: string) => Promise<void>;
  editMessage: (messageId: string, content: string) => Promise<void>;
  deleteMessage: (messageId: string) => Promise<void>;
  
  // 配置操作
  updateConfig: (config: Partial<OpenAIConfig>) => void;
};

// 数据库操作
export function useDatabase(): {
  isConnected: boolean;
  error: string | null;
  
  // 数据库操作
  backup: () => Promise<string>;
  restore: (backup: string) => Promise<void>;
  export: (format: 'json' | 'sql') => Promise<string>;
  import: (data: string, format: 'json' | 'sql') => Promise<void>;
};

// MCP管理
export function useMCP(): {
  servers: MCPServer[];
  availableTools: MCPTool[];
  isConnecting: boolean;
  
  // MCP操作
  addServer: (config: MCPServerConfig) => Promise<void>;
  removeServer: (serverId: string) => Promise<void>;
  testConnection: (serverId: string) => Promise<boolean>;
  executeTool: (toolName: string, params: any) => Promise<any>;
};
```

### 📁 项目结构

```
react-ai-chat/
├── src/
│   ├── components/
│   │   ├── AIChat/
│   │   │   ├── index.tsx              # 主组件
│   │   │   ├── ChatInterface.tsx      # 聊天界面
│   │   │   ├── MessageList.tsx        # 消息列表
│   │   │   ├── MessageItem.tsx        # 单条消息
│   │   │   ├── InputArea.tsx          # 输入区域
│   │   │   ├── SessionDropdown.tsx    # 会话下拉菜单
│   │   │   └── SettingsPanel.tsx      # 设置面板
│   │   ├── ui/
│   │   │   ├── Button.tsx
│   │   │   ├── Input.tsx
│   │   │   ├── Dialog.tsx
│   │   │   ├── Dropdown.tsx
│   │   │   └── Tooltip.tsx
│   │   └── providers/
│   │       ├── ChatProvider.tsx       # 聊天状态提供者
│   │       ├── DatabaseProvider.tsx   # 数据库提供者
│   │       └── ThemeProvider.tsx      # 主题提供者
│   ├── hooks/
│   │   ├── useChatStore.ts           # 聊天状态管理
│   │   ├── useDatabase.ts            # 数据库操作
│   │   ├── useMCP.ts                 # MCP管理
│   │   ├── useOpenAI.ts              # OpenAI客户端
│   │   └── useTheme.ts               # 主题管理
│   ├── lib/
│   │   ├── database/
│   │   │   ├── index.ts              # 数据库主入口
│   │   │   ├── schema.ts             # 数据库结构
│   │   │   ├── migrations.ts         # 数据库迁移
│   │   │   └── operations.ts         # 数据库操作
│   │   ├── openai/
│   │   │   ├── client.ts             # OpenAI客户端
│   │   │   ├── streaming.ts          # 流式处理
│   │   │   └── functions.ts          # 函数调用
│   │   ├── mcp/
│   │   │   ├── client.ts             # MCP客户端
│   │   │   ├── server.ts             # MCP服务器管理
│   │   │   └── tools.ts              # 工具管理
│   │   └── utils/
│   │       ├── markdown.ts           # Markdown处理
│   │       ├── export.ts             # 导出功能
│   │       ├── validation.ts         # 数据验证
│   │       └── constants.ts          # 常量定义
│   ├── types/
│   │   ├── index.ts                  # 主要类型定义
│   │   ├── database.ts               # 数据库类型
│   │   ├── openai.ts                 # OpenAI类型
│   │   └── mcp.ts                    # MCP类型
│   ├── styles/
│   │   ├── index.css                 # 主样式文件
│   │   ├── components.css            # 组件样式
│   │   ├── themes.css                # 主题样式
│   │   └── markdown.css              # Markdown样式
│   └── index.ts                      # 导出入口
├── examples/
│   ├── basic/                        # 基础使用示例
│   ├── advanced/                     # 高级配置示例
│   ├── custom-theme/                 # 自定义主题示例
│   └── mcp-integration/              # MCP集成示例
├── docs/
│   ├── README.md                     # 项目说明
│   ├── API.md                        # API文档
│   ├── EXAMPLES.md                   # 使用示例
│   ├── THEMING.md                    # 主题定制
│   ├── MCP.md                        # MCP配置
│   └── CONTRIBUTING.md               # 贡献指南
├── tests/
│   ├── components/                   # 组件测试
│   ├── hooks/                        # Hook测试
│   ├── lib/                          # 工具库测试
│   └── integration/                  # 集成测试
├── scripts/
│   ├── build.js                      # 构建脚本
│   ├── test.js                       # 测试脚本
│   └── release.js                    # 发布脚本
├── .github/
│   └── workflows/
│       ├── ci.yml                    # CI流程
│       └── release.yml               # 发布流程
├── package.json
├── tsconfig.json
├── vite.config.ts
├── rollup.config.js
├── tailwind.config.js
└── LICENSE
```

### 🧪 测试需求

#### 测试覆盖
- **单元测试**: 所有工具函数和Hook
- **组件测试**: React组件渲染和交互
- **集成测试**: 数据库操作和API调用
- **E2E测试**: 完整用户流程
- **性能测试**: 大量消息和会话处理

#### 测试配置
```json
{
  "testing": {
    "vitest": "^1.0.0",
    "@testing-library/react": "^14.0.0",
    "@testing-library/jest-dom": "^6.0.0",
    "@testing-library/user-event": "^14.0.0",
    "msw": "^2.0.0",
    "playwright": "^1.40.0"
  }
}
```

### 📦 打包和发布

#### 构建配置
```javascript
// rollup.config.js
export default {
  input: 'src/index.ts',
  output: [
    {
      file: 'dist/index.js',
      format: 'cjs',
      sourcemap: true,
    },
    {
      file: 'dist/index.esm.js',
      format: 'esm',
      sourcemap: true,
    },
  ],
  external: ['react', 'react-dom'],
  plugins: [
    peerDepsExternal(),
    resolve({ browser: true }),
    commonjs(),
    typescript({
      declaration: true,
      declarationDir: 'dist',
    }),
    postcss({
      extract: 'styles.css',
      minimize: true,
    }),
  ],
};
```

#### NPM包配置
```json
{
  "name": "@ai-chat/react-component",
  "version": "1.0.0",
  "description": "A complete React AI chat component with session management, MCP support, and SQLite persistence",
  "main": "dist/index.js",
  "module": "dist/index.esm.js",
  "types": "dist/index.d.ts",
  "files": ["dist", "README.md", "LICENSE"],
  "exports": {
    ".": {
      "import": "./dist/index.esm.js",
      "require": "./dist/index.js",
      "types": "./dist/index.d.ts"
    },
    "./styles": "./dist/styles.css"
  },
  "peerDependencies": {
    "react": ">=18.0.0",
    "react-dom": ">=18.0.0"
  },
  "keywords": [
    "react", "ai", "chat", "openai", "mcp", 
    "sqlite", "markdown", "typescript", "component"
  ]
}
```

### 🚀 使用示例

#### 基础使用
```tsx
import { AIChat } from '@ai-chat/react-component';
import '@ai-chat/react-component/styles';

function App() {
  return (
    <AIChat
      apiKey="your-openai-api-key"
      height="600px"
      systemPrompt="You are a helpful assistant."
    />
  );
}
```

#### 高级配置
```tsx
import { AIChat, useChatStore } from '@ai-chat/react-component';

function AdvancedChat() {
  const { sessions, currentSession } = useChatStore();

  return (
    <AIChat
      apiKey={process.env.REACT_APP_OPENAI_API_KEY}
      model="gpt-4-turbo-preview"
      height="100vh"
      theme="dark"
      enableMCP={true}
      mcpServers={[
        {
          id: '1',
          name: 'File System',
          serverUrl: 'mcp://filesystem',
          enabled: true,
        },
      ]}
      onSessionChange={(session) => {
        console.log('Session changed:', session);
      }}
      onTokenUsage={(usage) => {
        console.log('Token usage:', usage);
      }}
    />
  );
}
```

### 📚 文档需求

#### 必需文档
1. **README.md**: 项目介绍和快速开始
2. **API.md**: 完整API参考文档
3. **EXAMPLES.md**: 详细使用示例
4. **THEMING.md**: 主题定制指南
5. **MCP.md**: MCP配置和使用
6. **CONTRIBUTING.md**: 贡献指南
7. **CHANGELOG.md**: 版本更新日志

#### 在线文档
- 使用Storybook展示组件
- 部署在线演示站点
- 提供交互式API文档
