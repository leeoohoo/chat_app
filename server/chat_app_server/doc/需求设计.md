我来帮你设计一个完整的 Agent 封装方法。我会创建一个新的 `Agent` 类，让调用方可以更简单地使用。

## 设计方案

创建一个新文件 `agent.py`，提供简洁的 API：

```python
"""
Agent 封装类
提供简单易用的 Agent 接口，封装所有复杂的配置和调用逻辑
"""

import time
from typing import Dict, List, Any, Optional, Callable
from openai import OpenAI

from .message_manager import MessageManager
from .ai_request_handler import AiRequestHandler
from .tool_result_processor import ToolResultProcessor
from .mcp_tool_execute import McpToolExecute
from .ai_client import AiClient


class AgentConfig:
    """Agent 配置类"""
    
    def __init__(self,
                 api_key: str,
                 base_url: Optional[str] = None,
                 model_name: str = "gpt-4",
                 system_prompt: Optional[str] = None,
                 temperature: float = 0.7,
                 max_tokens: Optional[int] = None,
                 mcp_servers: Optional[List[Dict[str, Any]]] = None,
                 stdio_mcp_servers: Optional[List[Dict[str, Any]]] = None):
        """
        初始化 Agent 配置
        
        Args:
            api_key: OpenAI API 密钥
            base_url: API 基础 URL（可选）
            model_name: 模型名称
            system_prompt: 系统提示词
            temperature: 温度参数
            max_tokens: 最大 token 数
            mcp_servers: HTTP MCP 服务器列表
            stdio_mcp_servers: STDIO MCP 服务器列表
        """
        self.api_key = api_key
        self.base_url = base_url
        self.model_name = model_name
        self.system_prompt = system_prompt
        self.temperature = temperature
        self.max_tokens = max_tokens
        self.mcp_servers = mcp_servers or []
        self.stdio_mcp_servers = stdio_mcp_servers or []


class Agent:
    """
    Agent 封装类
    提供简单的接口来执行带工具调用的对话
    """
    
    def __init__(self, config: AgentConfig):
        """
        初始化 Agent
        
        Args:
            config: Agent 配置对象
        """
        self.config = config
        
        # 初始化 OpenAI 客户端
        client_kwargs = {"api_key": config.api_key}
        if config.base_url:
            client_kwargs["base_url"] = config.base_url
        self.openai_client = OpenAI(**client_kwargs)
        
        # 初始化 MCP 工具执行器
        self.mcp_tool_execute = McpToolExecute(
            mcp_servers=config.mcp_servers,
            stdio_mcp_servers=config.stdio_mcp_servers
        )
        self.mcp_tool_execute.init()
        
        # 初始化各个组件
        self.message_manager = MessageManager()
        self.ai_request_handler = AiRequestHandler(
            self.openai_client, 
            self.message_manager
        )
        self.tool_result_processor = ToolResultProcessor(
            self.message_manager,
            self.ai_request_handler
        )
        self.ai_client = AiClient(
            self.ai_request_handler,
            self.mcp_tool_execute,
            self.tool_result_processor,
            self.message_manager
        )
        
        print(f"[AGENT] 初始化完成 - 模型: {config.model_name}, 可用工具数: {len(self.mcp_tool_execute.tools)}")
    
    def run(self,
            messages: List[Dict[str, Any]],
            session_id: Optional[str] = None,
            tools: Optional[List[Dict[str, Any]]] = None,
            use_tools: bool = True,
            on_chunk: Optional[Callable[[str], None]] = None,
            on_tools_start: Optional[Callable[[List[Dict[str, Any]]], None]] = None,
            on_tools_stream: Optional[Callable[[Dict[str, Any]], None]] = None,
            on_tools_end: Optional[Callable[[List[Dict[str, Any]]], None]] = None,
            model_name: Optional[str] = None,
            temperature: Optional[float] = None,
            max_tokens: Optional[int] = None) -> Dict[str, Any]:
        """
        运行 Agent，处理消息并返回结果
        
        Args:
            messages: 消息列表，格式: [{"role": "user", "content": "..."}, ...]
            session_id: 会话 ID（可选，如果不提供则自动生成）
            tools: 自定义工具列表（可选，如果不提供则使用 MCP 工具）
            use_tools: 是否使用工具
            on_chunk: 流式响应回调
            on_tools_start: 工具开始调用回调
            on_tools_stream: 工具流式内容回调
            on_tools_end: 工具结束回调
            model_name: 模型名称（可选，覆盖配置）
            temperature: 温度参数（可选，覆盖配置）
            max_tokens: 最大 token 数（可选，覆盖配置）
            
        Returns:
            执行结果
        """
        try:
            # 生成会话 ID
            if not session_id:
                session_id = f"agent_session_{int(time.time() * 1000)}"
            
            print(f"[AGENT] 开始运行 - 会话ID: {session_id}, 消息数: {len(messages)}")
            
            # 准备消息列表
            prepared_messages = self._prepare_messages(messages)
            
            # 使用参数或配置中的值
            actual_model = model_name or self.config.model_name
            actual_temperature = temperature if temperature is not None else self.config.temperature
            actual_max_tokens = max_tokens or self.config.max_tokens
            
            # 确定使用的工具
            actual_tools = None
            if use_tools:
                if tools is not None:
                    actual_tools = tools
                else:
                    actual_tools = self.mcp_tool_execute.get_available_tools()
            
            print(f"[AGENT] 配置 - 模型: {actual_model}, 温度: {actual_temperature}, 工具数: {len(actual_tools) if actual_tools else 0}")
            
            # 如果没有工具，直接调用 AI
            if not actual_tools:
                return self._run_without_tools(
                    messages=prepared_messages,
                    session_id=session_id,
                    model=actual_model,
                    temperature=actual_temperature,
                    max_tokens=actual_max_tokens,
                    on_chunk=on_chunk
                )
            
            # 使用工具执行
            result = self.ai_client.process_request(
                messages=prepared_messages,
                session_id=session_id,
                model=actual_model,
                temperature=actual_temperature,
                max_tokens=actual_max_tokens,
                on_chunk=on_chunk,
                on_tools_start=on_tools_start,
                on_tools_stream=on_tools_stream,
                on_tools_end=on_tools_end
            )
            
            print(f"[AGENT] 运行完成 - 会话ID: {session_id}, 成功: {result.get('success', False)}")
            
            return result
            
        except Exception as e:
            error_message = f"Agent 运行失败: {str(e)}"
            print(f"[AGENT] 错误: {error_message}")
            import traceback
            traceback.print_exc()
            return {
                "success": False,
                "error": error_message
            }
    
    def chat(self,
             user_message: str,
             session_id: Optional[str] = None,
             conversation_history: Optional[List[Dict[str, Any]]] = None,
             **kwargs) -> Dict[str, Any]:
        """
        简化的聊天接口
        
        Args:
            user_message: 用户消息
            session_id: 会话 ID（可选）
            conversation_history: 对话历史（可选）
            **kwargs: 其他参数，传递给 run 方法
            
        Returns:
            执行结果
        """
        # 构建消息列表
        messages = conversation_history or []
        
        # 添加用户消息
        messages.append({
            "role": "user",
            "content": user_message
        })
        
        return self.run(
            messages=messages,
            session_id=session_id,
            **kwargs
        )
    
    def _prepare_messages(self, messages: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
        """
        准备消息列表，添加系统提示词
        
        Args:
            messages: 原始消息列表
            
        Returns:
            处理后的消息列表
        """
        prepared = []
        
        # 添加系统提示词（如果配置了）
        if self.config.system_prompt:
            prepared.append({
                "role": "system",
                "content": self.config.system_prompt
            })
        
        # 添加其他消息
        prepared.extend(messages)
        
        return prepared
    
    def _run_without_tools(self,
                          messages: List[Dict[str, Any]],
                          session_id: str,
                          model: str,
                          temperature: float,
                          max_tokens: Optional[int],
                          on_chunk: Optional[Callable[[str], None]]) -> Dict[str, Any]:
        """
        不使用工具的简单执行
        
        Args:
            messages: 消息列表
            session_id: 会话 ID
            model: 模型名称
            temperature: 温度参数
            max_tokens: 最大 token 数
            on_chunk: 流式回调
            
        Returns:
            执行结果
        """
        try:
            print(f"[AGENT] 无工具模式运行 - 会话ID: {session_id}")
            
            response = self.ai_request_handler.handle_request(
                messages=messages,
                tools=None,
                model=model,
                temperature=temperature,
                max_tokens=max_tokens,
                session_id=session_id,
                on_chunk=on_chunk
            )
            
            if response.get("success"):
                return {
                    "success": True,
                    "final_response": response,
                    "iterations": 1,
                    "has_tool_calls": False
                }
            else:
                return {
                    "success": False,
                    "error": response.get("error", "AI 请求失败"),
                    "final_response": None
                }
                
        except Exception as e:
            error_message = f"无工具执行失败: {str(e)}"
            print(f"[AGENT] 错误: {error_message}")
            return {
                "success": False,
                "error": error_message,
                "final_response": None
            }
    
    def get_available_tools(self) -> List[Dict[str, Any]]:
        """
        获取可用工具列表
        
        Returns:
            工具列表
        """
        return self.mcp_tool_execute.get_available_tools()
    
    def get_conversation_history(self, session_id: str, limit: Optional[int] = None) -> List[Dict[str, Any]]:
        """
        获取对话历史
        
        Args:
            session_id: 会话 ID
            limit: 消息数量限制
            
        Returns:
            消息列表
        """
        return self.message_manager.get_session_messages(session_id, limit)


# 便捷函数
def create_agent(api_key: str,
                base_url: Optional[str] = None,
                model_name: str = "gpt-4",
                system_prompt: Optional[str] = None,
                temperature: float = 0.7,
                max_tokens: Optional[int] = None,
                mcp_servers: Optional[List[Dict[str, Any]]] = None,
                stdio_mcp_servers: Optional[List[Dict[str, Any]]] = None) -> Agent:
    """
    创建 Agent 的便捷函数
    
    Args:
        api_key: OpenAI API 密钥
        base_url: API 基础 URL（可选）
        model_name: 模型名称
        system_prompt: 系统提示词
        temperature: 温度参数
        max_tokens: 最大 token 数
        mcp_servers: HTTP MCP 服务器列表
        stdio_mcp_servers: STDIO MCP 服务器列表
        
    Returns:
        Agent 实例
    """
    config = AgentConfig(
        api_key=api_key,
        base_url=base_url,
        model_name=model_name,
        system_prompt=system_prompt,
        temperature=temperature,
        max_tokens=max_tokens,
        mcp_servers=mcp_servers,
        stdio_mcp_servers=stdio_mcp_servers
    )
    
    return Agent(config)
```

## 使用示例

### 1. 基本使用

```python
from ai_services.v2.agent import create_agent

# 创建 Agent
agent = create_agent(
    api_key="your-api-key",
    model_name="gpt-4",
    system_prompt="你是一个有帮助的助手。",
    mcp_servers=[
        {"name": "weather", "url": "http://localhost:8000/mcp"}
    ]
)

# 简单对话
result = agent.chat(
    user_message="今天天气怎么样？",
    session_id="my_session"
)

print(result)
```

### 2. 带回调的使用

```python
def on_chunk(chunk: str):
    print(chunk, end="", flush=True)

def on_tools_start(tool_calls):
    print(f"\n开始调用 {len(tool_calls)} 个工具...")

def on_tools_stream(tool_data):
    print(f"工具 {tool_data['name']}: {tool_data['content']}")

def on_tools_end(tool_results):
    print(f"\n工具调用完成，共 {len(tool_results)} 个结果")

result = agent.chat(
    user_message="查询北京的天气",
    session_id="my_session",
    on_chunk=on_chunk,
    on_tools_start=on_tools_start,
    on_tools_stream=on_tools_stream,
    on_tools_end=on_tools_end
)
```

### 3. 完整配置使用

```python
from ai_services.v2.agent import Agent, AgentConfig

# 详细配置
config = AgentConfig(
    api_key="your-api-key",
    base_url="https://api.openai.com/v1",
    model_name="gpt-4-turbo",
    system_prompt="你是一个专业的数据分析助手。",
    temperature=0.5,
    max_tokens=2000,
    mcp_servers=[
        {"name": "weather", "url": "http://localhost:8000/mcp"},
        {"name": "database", "url": "http://localhost:8001/mcp"}
    ],
    stdio_mcp_servers=[
        {
            "name": "filesystem",
            "command": "python",
            "args": ["-m", "mcp_server_filesystem"],
            "cwd": "/path/to/workspace"
        }
    ]
)

agent = Agent(config)

# 使用对话历史
history = [
    {"role": "user", "content": "你好"},
    {"role": "assistant", "content": "你好！我是数据分析助手。"}
]

result = agent.chat(
    user_message="帮我分析一下销售数据",
    conversation_history=history,
    session_id="analysis_session"
)
```

### 4. 高级使用 - run 方法

```python
messages = [
    {"role": "user", "content": "第一个问题"},
    {"role": "assistant", "content": "第一个回答"},
    {"role": "user", "content": "第二个问题"}
]

result = agent.run(
    messages=messages,
    session_id="advanced_session",
    use_tools=True,
    temperature=0.8,
    max_tokens=1500
)

# 获取最终响应
if result.get("success"):
    final_response = result.get("final_response")
    content = final_response["choices"][0]["message"]["content"]
    print(f"回答: {content}")
    print(f"迭代次数: {result.get('iterations', 0)}")
```

## 更新 `__init__.py`

```python
"""
V2版本的AI服务模块
提供完整的聊天服务功能，包括消息管理、AI请求处理、工具执行等
"""

from .message_manager import MessageManager
from .ai_request_handler import AiRequestHandler
from .tool_result_processor import ToolResultProcessor
from .mcp_tool_execute import McpToolExecute
from .ai_client import AiClient
from .ai_server import AiServer
from .chat_service import ChatService
from .agent import Agent, AgentConfig, create_agent

__all__ = [
    'MessageManager',
    'AiRequestHandler',
    'ToolResultProcessor',
    'McpToolExecute',
    'AiClient',
    'AiServer',
    'ChatService',
    'Agent',
    'AgentConfig',
    'create_agent'
]
```

## 主要特点

1. **简化配置**：通过 `AgentConfig` 类集中管理所有配置
2. **便捷创建**：提供 `create_agent` 函数快速创建实例
3. **灵活使用**：支持 `chat` 和 `run` 两种调用方式
4. **完整回调**：支持所有回调函数（流式、工具开始/结束等）
5. **参数覆盖**：运行时可以覆盖配置中的参数
6. **自动管理**：自动处理会话 ID、消息历史等
7. **错误处理**：完善的异常处理和日志输出

这样调用方就可以非常简单地使用 Agent 功能了！